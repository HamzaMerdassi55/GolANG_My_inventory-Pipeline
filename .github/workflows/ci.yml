name: Continuous Integration 
on: 
  push: 
env:
  DB_NAME: test
  DB_USER: root 
  DB_PASSWORD: Hamza#123
jobs:
  run_code_checks: 
    runs-on: ubuntu-latest  
    steps: 
      - name: Set up MySQL
        run: |
          sudo /etc/init.d/mysql start
          sudo mysql -e 'ALTER USER "${{ env.DB_USER }}"@"localhost" IDENTIFIED BY "${{ env.DB_PASSWORD }}";' -uroot -proot
          sudo mysql -e 'CREATE DATABASE ${{ env.DB_NAME }};' -u${{ env.DB_USER }} -p${{ env.DB_PASSWORD }}

      - name: Checkout repository 
        uses: actions/checkout@v2 

      - name: Set Up Go 
        uses: actions/setup-go@v2
        with:
          go-version: '1.23.1'

      - name: Run linting
        run: |
          go fmt ./...
          go vet ./...

      - name: Run tests
        run: go test ./...

  build_docker_image:
    runs-on: ubuntu-latest
    needs: run_code_checks
    steps:
    - name: Checkout repository 
      uses: actions/checkout@v2 

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      run: |
        docker buildx build --tag ${{ env.DOCKER_IMAGE_NAME }} --push .